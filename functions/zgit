# Part of zconfig · https://github.com/barabasz/zconfig · MIT License
#
# Git wrapper for bulk operations on repositories defined in $GHDIR
# Use 'zgit --help' for more information.

local -A _fn=(
    [info]="Git wrapper for bulk operations on repositories"
    [desc]="Performs git operations (pull, push, status, reset) on all repositories
            located in the ${c}\$GHDIR${x} directory."
    [version]="0.5.1"
    [created]="2025"
    [modified]="2026-02-08"
    [license]="MIT"
    [author]="Andrzej Barabasz"
    [required]="git"
    [notes]="Requires ${c}\$GHDIR${x} to be set to the parent directory containing your git repositories."
)

local -a _fn_args=(
    "command|Command to execute|o"
)

local -a _fn_commands=(
    "pull|Pull --rebase all repos"
    "push|Commit and push all repos"
    "push-force|Force push current directory to origin/main"
    "list|List all repositories"
    "reset|Hard reset all repos to origin/main"
    "status|Show status for all repos"
)

local -a _fn_examples=(
    "zgit pull|Pull all repos"
    "zgit push|Commit and push all repos"
    "zgit status|Show status for all repos"
)

local -A opts=() args=()
_fn_init "$@" || return $REPLY

# Ensure configuration is present
if [[ -z "$GHDIR" ]]; then
    printe "\$GHDIR is not set."
    return 1
fi

local cmd="${args[command]:-help}"

# Define repository list glob pattern
local repo_glob="$GHDIR/*(/)"

case "$cmd" in
    pull)
        local -a repos=($~repo_glob)
        local count=${#repos}
        (( count == 0 )) && { printe "No repositories found in $GHDIR."; return 1; }

        printc "Pulling $count repositories from the remote." $y
        print "Working directory: $c$GHDIR$x"

        local i=1 repo
        for repo in $repos; do
            printc "\n$i/$count ${repo:t}" $g
            printc "$(git -C "$repo" remote get-url origin)" $c

            git -C "$repo" pull --rebase 2>&1 | while read line; do
                if [[ "$line" == *"error:"* ]]; then
                    print -- "$r$line$x"
                else
                    print -- "$line"
                fi
            done
            ((i++))
        done
        ;;

    push)
        local -a repos=($~repo_glob)
        local count=${#repos}
        (( count == 0 )) && { printe "No repositories found in $GHDIR."; return 1; }

        printc "Pushing $count repositories to the remote." $y
        print "Working directory: $c$GHDIR$x"

        local i=1 repo
        for repo in $repos; do
            printc "\n$i/$count ${repo:t}" $g
            printc "$(git -C "$repo" remote get-url origin)" $c

            git -C "$repo" add --all
            git -C "$repo" commit -m "update" >/dev/null 2>&1
            git -C "$repo" push
            ((i++))
        done
        ;;

    push-force)
        printc "Running force push sequence on CURRENT directory..." $y

        git add --all
        git commit -m "update"
        git rebase --continue 2>/dev/null
        git push origin HEAD:main --force
        ;;

    list)
        print -l $~repo_glob
        ;;

    reset)
        local -a repos=($~repo_glob)
        local count=${#repos}
        (( count == 0 )) && { printe "No repositories found in $GHDIR."; return 1; }

        printe "WARNING: This will reset ALL $count repositories to the latest commit on the main branch."

        if ! read -q "?${y}Are you sure you want to continue? [y/N] ${x}"; then
            print ""
            return 1
        fi
        print ""

        local i=1 repo
        for repo in $repos; do
            printc "$i/$count ${repo:t}" $g
            printc "$(git -C "$repo" remote get-url origin)" $c

            git -C "$repo" fetch origin
            git -C "$repo" checkout main
            git -C "$repo" reset --hard origin/main
            git -C "$repo" pull
            ((i++))
        done
        ;;

    status)
        local -a repos=($~repo_glob)
        local count=${#repos}
        (( count == 0 )) && { printe "No repositories found in $GHDIR."; return 1; }

        printc "Checking status for $count repositories." $y

        local i=1 repo
        for repo in $repos; do
            printc "$i/$count ${repo:t}" $g
            git -C "$repo" status -s
            ((i++))
        done
        ;;

    help)
        _fn_usage >&2
        ;;

    *)
        printe "Unknown command: $cmd"
        printi "Use 'zgit --help' to see available commands."
        return 1
        ;;
esac
