# Part of zconfig · https://github.com/barabasz/zconfig · MIT License
#
# Measure Time To First Byte (TTFB) for a given URL
# Use 'ttfb --help' for more information.

local -A _fn=(
    [info]="Measure Time To First Byte (TTFB) for a URL"
    [desc]="Measures how long it takes to receive the first byte from a server.
            Useful for testing server response time and latency."
    [version]="0.5.1"
    [created]="2024-03-10"
    [modified]="2026-02-08"
    [license]="MIT"
    [author]="Andrzej Barabasz"
    [required]="curl"
    [notes]="Protocol (https://) is added automatically if missing."
)

local -a _fn_args=(
    "url|URL or hostname to measure|r"
)

local -a _fn_examples=(
    "ttfb google.com|Measure TTFB for google.com"
    "ttfb https://example.com|Measure with explicit protocol"
)

local -A opts=() args=()
_fn_init "$@" || return $REPLY

local url="${args[url]}"

# Add protocol if missing
[[ $url != http* ]] && url="https://$url"

local ttfb_s

# Process substitution to avoid subshell overhead
read -r ttfb_s < <(curl -s -w "%{time_starttransfer}" -o /dev/null "$url" 2>/dev/null)

# Verify if curl returned a valid value
if [[ -z "$ttfb_s" || "$ttfb_s" == "0.000000" || "$ttfb_s" == "0,000000" ]]; then
    printe "Could not connect to: ${args[url]}"
    return 1
fi

# Native float math and formatting
print -f "%.2f ms\n" $(( ttfb_s * 1000 ))
